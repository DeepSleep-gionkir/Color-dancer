<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ‘» ì—ì½” ì í¼ (Echo Jumper)</title>
    <style>
        /* --- ê¸°ë³¸ ë° ë ˆì´ì•„ì›ƒ --- */
        html, body {
            margin: 0;
            padding: 0;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            background-color: #1a1a2e; /* ì–´ë‘ìš´ ë‚¨ìƒ‰ ë°¤í•˜ëŠ˜ */
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            touch-action: none; /* ëª¨ë°”ì¼ ìŠ¤í¬ë¡¤/ì¤Œ ë°©ì§€ */
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            height: 100%;
            max-height: 800px;
            overflow: hidden;
        }

        #game-canvas {
            background-color: #2a2a3e; /* ë¬˜ì§€ ë°°ê²½ìƒ‰ */
            border: 2px solid #50507a;
            cursor: none;
            display: block;
        }

        /* --- UI ì˜ì—­ --- */
        #ui-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            z-index: 5;
        }
        
        /* ë¹™ì˜ ê²Œì´ì§€ ë°” */
        #gauge-container {
            width: 100%;
            height: 25px;
            background-color: rgba(0, 0, 0, 0.3);
            border: 2px solid #fff;
            border-radius: 15px;
            overflow: hidden;
            display: none; /* ìœ ë ¹ ìƒíƒœì¼ ë• ìˆ¨ê¹€ */
        }

        #gauge-bar {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #00FFFF, #00BFFF);
            transition: width 0.1s linear;
        }

        /* ìƒë‹¨ UI (ì ìˆ˜, ë ˆë²¨) */
        #top-ui {
            position: absolute;
            top: 10px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 15px;
            box-sizing: border-box;
            font-size: 1.5em;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 5px #000;
            z-index: 5;
        }

        /* --- ì‹œì‘/ì¢…ë£Œ/ì •ë³´ ì˜¤ë²„ë ˆì´ --- */
        #game-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(10, 10, 20, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: opacity 0.5s ease, visibility 0.5s;
            visibility: visible;
            opacity: 1;
            z-index: 10;
            overflow-y: auto; /* ì •ë³´ê°€ ê¸¸ì–´ì§€ë©´ ìŠ¤í¬ë¡¤ */
        }

        #game-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        #game-overlay h1 {
            color: #00FFFF; /* ë„¤ì˜¨ ì‹œì•ˆ */
            margin-bottom: 10px;
        }

        #game-overlay p {
            font-size: 1.1em;
            margin: 10px 20px;
        }

        #start-button {
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            color: #1a1a2e;
            background-color: #00FFFF;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 0 20px #00FFFF;
            margin-top: 20px;
        }

        #final-score {
            font-size: 1.5em;
            font-weight: bold;
            color: #FF00FF; /* ë„¤ì˜¨ ë§ˆì  íƒ€ */
            margin: 10px 0;
        }
        
        /* ì •ë³´ ë²„íŠ¼ */
        #info-button {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid #fff;
            border-radius: 50%;
            color: white;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            z-index: 11;
        }
        
        /* ìƒì„¸ 'ê²Œì„ ë°©ë²•' UI (ìƒˆë¡œ ì¶”ê°€) */
        #instructions {
            display: none; /* í‰ì†Œì—” ìˆ¨ê¹€ */
            width: 90%;
            text-align: left;
            padding: 10px;
        }
        
        #instructions h3 {
            color: #00FFFF;
            border-bottom: 1px solid #00FFFF;
            padding-bottom: 5px;
        }
        
        #instructions ul {
            padding-left: 20px;
            margin: 0 0 15px 0;
        }
        
        #instructions li {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        #instructions b {
            color: #FFFF00; /* ë…¸ë€ìƒ‰ ê°•ì¡° */
        }
    </style>
</head>
<body>

    <div id="game-container">
        
        <button id="info-button">?</button>

        <div id="top-ui">
            <div id="score">Score: 0</div>
            <div id="level">Lv. 1</div>
        </div>

        <canvas id="game-canvas"></canvas>

        <div id="ui-container">
            <div id="gauge-container">
                <div id="gauge-bar"></div>
            </div>
        </div>
        
        <div id="game-overlay" data-mode="start">
            <h1>ğŸ‘» ì—ì½” ì í¼ ğŸ‘»</h1>
            <p id="overlay-message">
                ì ì˜ ëª¸ì„ ë¹¼ì•—ì•„ ì‹¸ìš°ì„¸ìš”!<br>
                ìˆ™ì£¼ê°€ íŒŒê´´ë˜ê¸° ì „ì— ë‹¤ìŒ ì ìœ¼ë¡œ 'ì í”„'í•˜ì„¸ìš”.
            </p>
            
            <div id="instructions">
                <h3>1. ê¸°ë³¸ í”Œë ˆì´ ë°©ë²•</h3>
                <ul>
                    <li><b>ì´ë™:</b> í™”ë©´ì„ ë“œë˜ê·¸(PC: ë§ˆìš°ìŠ¤ ì´ë™)í•˜ì—¬ ì›€ì§ì…ë‹ˆë‹¤.</li>
                    <li><b>ë¹™ì˜ (ê³µê²©):</b> í™”ë©´ì„ íƒ­(PC: í´ë¦­)í•˜ì—¬ ê°€ì¥ ê°€ê¹Œìš´ ì ìœ¼ë¡œ 'ëŒ€ì‹œ'í•©ë‹ˆë‹¤. ëª¬ìŠ¤í„°ì—ê²Œ ë‹¿ìœ¼ë©´ 'ë¹™ì˜'í•©ë‹ˆë‹¤.</li>
                    <li><b>ìˆ™ì£¼ ìƒíƒœ:</b> ë¹™ì˜ì— ì„±ê³µí•˜ë©´ ëª¬ìŠ¤í„°ë¥¼ ì¡°ì¢…í•˜ë©°, í•´ë‹¹ ëª¬ìŠ¤í„°ì˜ ê³ ìœ  ëŠ¥ë ¥ì´ <b>ìë™ìœ¼ë¡œ ë°œë™</b>ë©ë‹ˆë‹¤.</li>
                    <li><b>ìˆ™ì£¼ í•œê³„:</b> í•˜ë‹¨ì˜ <b>'ë¹™ì˜ ê²Œì´ì§€'</b>ëŠ” <b>ì§€ì†ì ìœ¼ë¡œ ê°ì†Œ</b>í•©ë‹ˆë‹¤. ê²Œì´ì§€ê°€ 0ì´ ë˜ë©´ ìˆ™ì£¼ê°€ íŒŒê´´ë˜ê³  ë‹¹ì‹ ì€ 'ìœ ë ¹' ìƒíƒœê°€ ë©ë‹ˆë‹¤.</li>
                    <li><b>'ì í”„' (ê°ˆì•„íƒ€ê¸°):</b> ê²Œì´ì§€ê°€ 0ì´ ë˜ê¸° ì „ì— ë‹¤ì‹œ íƒ­/í´ë¦­í•˜ì—¬ <b>ë‹¤ë¥¸ ëª¬ìŠ¤í„°ë¡œ ê°ˆì•„íƒ€ì•¼</b> í•©ë‹ˆë‹¤. ì´ê²ƒì´ 'ì í”„'ì…ë‹ˆë‹¤.</li>
                    <li><b>ê²Œì„ ì˜¤ë²„:</b> 'ìœ ë ¹' ìƒíƒœì—ì„œ ëª¬ìŠ¤í„°ì—ê²Œ ë‹¿ê±°ë‚˜, ìˆ™ì£¼ê°€ íŒŒê´´ëœ ì§í›„ ëª¬ìŠ¤í„°ì—ê²Œ ë‹¿ìœ¼ë©´ ê²Œì„ì´ ì¢…ë£Œë©ë‹ˆë‹¤.</li>
                </ul>
                
                <h3>2. ëª¬ìŠ¤í„°(ìˆ™ì£¼) íŠ¹ì§•</h3>
                <ul>
                    <li><b>ğŸ’€ ìŠ¤ì¼ˆë ˆí†¤:</b> [ë°¸ëŸ°ìŠ¤í˜•] ê°€ê¹Œìš´ ì ì—ê²Œ ë¼ˆë‹¤ê·€ë¥¼ ë˜ì§‘ë‹ˆë‹¤. (ê¸°ë³¸ ì›ê±°ë¦¬)</li>
                    <li><b>ğŸ§Ÿ ì¢€ë¹„:</b> [ê´‘ì—­/ë°©ì–´í˜•] ì£¼ë³€ì— 'ë¶€íŒ¨ ì˜¤ë¼'ë¥¼ ë°©ì¶œí•©ë‹ˆë‹¤. ê²Œì´ì§€ê°€ ë§¤ìš° ê¹ë‹ˆë‹¤.</li>
                    <li><b>ğŸ¦‡ ë°•ì¥:</b> [ê¸°ë™/ê´€í†µí˜•] ì „ë°©ìœ¼ë¡œ 'ì´ˆìŒíŒŒ'ë¥¼ ì©ë‹ˆë‹¤. ì´ë™ ì†ë„ê°€ ë§¤ìš° ë¹ ë¥´ì§€ë§Œ ê²Œì´ì§€ê°€ ì§§ìŠµë‹ˆë‹¤.</li>
                    <li><b>ğŸ‘»ğŸ¹ ê³ ìŠ¤íŠ¸ ì•„ì²˜:</b> [ì €ê²©í˜•] ê°€ì¥ ë©€ë¦¬ ìˆëŠ” ì ì—ê²Œ ìœ ë„ í™”ì‚´ì„ ì©ë‹ˆë‹¤.</li>
                    <li><b>ğŸ—¿ ê°€ê³ ì¼:</b> [ë°©ì–´í˜•] <b>ê³µê²© ëŠ¥ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</b> ëŒ€ì‹  ë¹™ì˜ ê²Œì´ì§€ê°€ ì••ë„ì ìœ¼ë¡œ ê¸¸ì–´ 'ì•ˆì „ì§€ëŒ€' ì—­í• ì„ í•©ë‹ˆë‹¤.</li>
                    <li><b>ğŸ•·ï¸ ìŠ¤íŒŒì´ë”:</b> [ì „ëµí˜•] <b>ë°ë¯¸ì§€ê°€ ê±°ì˜ ì—†ìŠµë‹ˆë‹¤.</b> ì´ë™ ê²½ë¡œì— ì ì„ ëŠë¦¬ê²Œ í•˜ëŠ” ê±°ë¯¸ì¤„ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤.</li>
                    <li><b>ğŸ’¥ í­ë°œ ì„í”„:</b> [ìí­í˜•] <b>ë¹™ì˜ ê²Œì´ì§€ê°€ 3ì´ˆ</b>ì…ë‹ˆë‹¤. ë¹™ì˜ë¥¼ 'ê·¸ë§Œë‘ëŠ” ìˆœê°„' (ë‹¤ë¥¸ ì ìœ¼ë¡œ ì í”„ ì‹œ) ê°•ë ¥í•˜ê²Œ ìí­í•©ë‹ˆë‹¤.</li>
                </ul>
                
                <h3>3. ê¸°ëŠ¥ (ë ˆë²¨ ì—…)</h3>
                <ul>
                    <li>ì ì„ ì²˜ì¹˜í•˜ê³  'ì—ì½”(ğŸ’)'ë¥¼ ëª¨ìœ¼ë©´ ë ˆë²¨ ì—… í•©ë‹ˆë‹¤.</li>
                    <li>ë ˆë²¨ ì—… ì‹œ, 3ê°€ì§€ ë¬´ì‘ìœ„ ëŠ¥ë ¥ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.</li>
                    <li><b>ìœ ë ¹(Wisp) ê°•í™”:</b> (ì˜êµ¬ì ) 'ëŒ€ì‹œ ì¿¨íƒ€ì„ ê°ì†Œ', 'ìœ ë ¹ ìƒíƒœ ì´ì† ì¦ê°€' ë“±</li>
                    <li><b>ìˆ™ì£¼(Host) ê°•í™”:</b> (ë¹™ì˜ ë™ì•ˆ) 'ë¹™ì˜ ê²Œì´ì§€ ì´ëŸ‰ ì¦ê°€', 'ê³µê²©ë ¥/ê³µê²©ì†ë„ ì¦ê°€' ë“±</li>
                    <li><b>ì í”„(Jump) ê°•í™”:</b> (ì „ëµ) 'ì í”„ ì‹œ í­ë°œ', 'ì í”„ ì‹œ ê²Œì´ì§€ íšŒë³µ' ë“±</li>
                </ul>
            </div>
            
            <p id="final-score"></p>
            <button id="start-button">ì‹œì‘í•˜ê¸°</button>
        </div>
        
        </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- DOM ìš”ì†Œ ---
            const gameContainer = document.getElementById('game-container');
            const canvas = document.getElementById('game-canvas');
            const ctx = canvas.getContext('2d');
            const gameOverlay = document.getElementById('game-overlay');
            const startButton = document.getElementById('start-button');
            const finalScoreDisplay = document.getElementById('final-score');
            const infoButton = document.getElementById('info-button');
            const instructions = document.getElementById('instructions');
            const overlayMessage = document.getElementById('overlay-message');
            
            const scoreDisplay = document.getElementById('score');
            const levelDisplay = document.getElementById('level');
            const gaugeContainer = document.getElementById('gauge-container');
            const gaugeBar = document.getElementById('gauge-bar');

            // --- ìº”ë²„ìŠ¤ í¬ê¸° ---
            const VIEWPORT_WIDTH = gameContainer.clientWidth;
            const VIEWPORT_HEIGHT = gameContainer.clientHeight;
            canvas.width = VIEWPORT_WIDTH;
            canvas.height = VIEWPORT_HEIGHT;

            // --- ê²Œì„ ìƒíƒœ ë° ì„¤ì • ---
            let gameState = 'start'; // 'start', 'playing', 'over'
            let score = 0;
            let level = 1;
            let gameLoopId = null;
            let frameCount = 0;

            let player, enemies, projectiles, echoes;

            // --- ë§ˆìš°ìŠ¤/í„°ì¹˜ ìœ„ì¹˜ ---
            let targetPos = { x: VIEWPORT_WIDTH / 2, y: VIEWPORT_HEIGHT / 2 };

            // --- ëª¬ìŠ¤í„° ì†ì„± ì •ì˜ ---
            const MOB_PROPERTIES = {
                'skeleton': { gauge: 1000, attackType: 'bone', attackCooldown: 50, speed: 2, icon: 'ğŸ’€' },
                'zombie': { gauge: 2000, attackType: 'aura', attackCooldown: 1, speed: 1.2, icon: 'ğŸ§Ÿ' },
                'bat': { gauge: 600, attackType: 'sonic', attackCooldown: 30, speed: 3.5, icon: 'ğŸ¦‡' },
                'archer': { gauge: 800, attackType: 'arrow', attackCooldown: 100, speed: 1.5, icon: 'ğŸ‘»ğŸ¹' },
                'gargoyle': { gauge: 4000, attackType: 'none', attackCooldown: 999, speed: 0.5, icon: 'ğŸ—¿' },
                'spider': { gauge: 1000, attackType: 'web', attackCooldown: 60, speed: 2.5, icon: 'ğŸ•·ï¸' },
                'imp': { gauge: 180, attackType: 'none', attackCooldown: 999, speed: 2, icon: 'ğŸ’¥' },
            };
            const MOB_TYPES = Object.keys(MOB_PROPERTIES);

            // --- í”Œë ˆì´ì–´ í´ë˜ìŠ¤ ---
            class Player {
                constructor() {
                    this.x = VIEWPORT_WIDTH / 2;
                    this.y = VIEWPORT_HEIGHT / 2;
                    this.radius = 10;
                    this.state = 'WISP'; // 'WISP', 'HOST', 'UNPOSSESSING' (ë¬´ì  ì‹œê°„)
                    this.hostType = null;
                    this.gauge = 0;
                    this.maxGauge = 0;
                    this.speed = 3;
                    this.attackTimer = 0;
                    this.dashCooldown = 0;
                    this.unpossessTimer = 0; // ë¬´ì  ì‹œê°„
                }

                draw() {
                    ctx.font = '24px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    if (this.state === 'WISP') {
                        ctx.fillStyle = (this.unpossessTimer > 0) ? 'rgba(0, 255, 255, 0.5)' : '#00FFFF'; // ë¬´ì  ì‹œ ë°˜íˆ¬ëª…
                        ctx.fillText('ğŸ‘»', this.x, this.y);
                    } else if (this.state === 'HOST') {
                        const icon = MOB_PROPERTIES[this.hostType].icon;
                        ctx.fillText(icon, this.x, this.y);
                        // í”Œë ˆì´ì–´ í‘œì‹œ (ì‘ì€ ì‚¼ê°í˜•)
                        ctx.fillStyle = '#00FFFF';
                        ctx.beginPath();
                        ctx.moveTo(this.x, this.y - 20);
                        ctx.lineTo(this.x - 5, this.y - 15);
                        ctx.lineTo(this.x + 5, this.y - 15);
                        ctx.closePath();
                        ctx.fill();
                    }
                }

                update() {
                    // ë¬´ì  ì‹œê°„ ê°±ì‹ 
                    if (this.unpossessTimer > 0) {
                        this.unpossessTimer--;
                        if (this.unpossessTimer <= 0) this.state = 'WISP';
                    }
                    if (this.dashCooldown > 0) this.dashCooldown--;

                    // ì´ë™ (ëª©í‘œ ì§€ì ìœ¼ë¡œ ë¶€ë“œëŸ½ê²Œ)
                    const dx = targetPos.x - this.x;
                    const dy = targetPos.y - this.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist > this.speed) {
                        this.x += (dx / dist) * this.speed;
                        this.y += (dy / dist) * this.speed;
                    }
                    
                    // ìˆ™ì£¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                    if (this.state === 'HOST') {
                        this.gauge--;
                        gaugeBar.style.width = `${(this.gauge / this.maxGauge) * 100}%`;
                        
                        if (this.gauge <= 0) this.unpossess();
                        
                        this.attackTimer--;
                        if (this.attackTimer <= 0) this.attack();
                    }
                }
                
                attack() {
                    if (!this.hostType) return;
                    const props = MOB_PROPERTIES[this.hostType];
                    this.attackTimer = props.attackCooldown;
                    // (TODO: ì—¬ê¸°ì— ëª¬ìŠ¤í„°ë³„ ê³µê²© ë¡œì§ (Projectile ìƒì„±) êµ¬í˜„)
                }
                
                // ëŒ€ì‹œ & ë¹™ì˜
                dash() {
                    if (this.dashCooldown > 0) return;
                    this.dashCooldown = 30; // 0.5ì´ˆ ì¿¨íƒ€ì„
                    
                    let closestEnemy = null;
                    let minDist = Infinity;
                    
                    enemies.forEach(enemy => {
                        const dist = Math.hypot(this.x - enemy.x, this.y - enemy.y);
                        if (dist < minDist && dist < 200) { // 200px ë²”ìœ„ ë‚´
                            minDist = dist;
                            closestEnemy = enemy;
                        }
                    });
                    
                    if (closestEnemy) {
                        // 'ì í”„' ë¡œì§ (ê¸°ì¡´ ìˆ™ì£¼ê°€ ìˆì—ˆë‹¤ë©´)
                        if (this.state === 'HOST' && this.hostType === 'imp') {
                            // (TODO: ì„í”„ ìí­ ë¡œì§)
                        }
                        
                        this.possess(closestEnemy);
                    }
                }

                possess(enemy) {
                    this.state = 'HOST';
                    this.hostType = enemy.type;
                    const props = MOB_PROPERTIES[this.hostType];
                    this.maxGauge = props.gauge;
                    this.gauge = this.maxGauge;
                    this.speed = props.speed;
                    this.x = enemy.x; // ìœ„ì¹˜ ë™ê¸°í™”
                    this.y = enemy.y;
                    targetPos.x = this.x; // ë§ˆìš°ìŠ¤ ìœ„ì¹˜ë„ ë™ê¸°í™”
                    targetPos.y = this.y;
                    
                    gaugeContainer.style.display = 'block';
                    
                    // ë¹™ì˜í•œ ì  ì œê±°
                    enemies = enemies.filter(e => e !== enemy);
                }

                unpossess() {
                    if (this.hostType === 'imp') {
                        // (TODO: ì„í”„ ìí­ ë¡œì§)
                    }
                    this.state = 'UNPOSSESSING'; // ë¬´ì  ìƒíƒœ
                    this.unpossessTimer = 60; // 1ì´ˆ ë¬´ì 
                    this.hostType = null;
                    this.gauge = 0;
                    this.speed = 4; // ìœ ë ¹ ì´ì†
                    gaugeContainer.style.display = 'none';
                }
            }
            
            // (TODO: Enemy, Projectile, Echo í´ë˜ìŠ¤ êµ¬í˜„ í•„ìš”)
            class Enemy {
                constructor(x, y, type) {
                    this.x = x;
                    this.y = y;
                    this.type = type;
                    this.radius = 12;
                    this.icon = MOB_PROPERTIES[type].icon;
                }
                draw() {
                    ctx.font = '24px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(this.icon, this.x, this.y);
                }
                update() {
                    // (TODO: í”Œë ˆì´ì–´ ë°©í–¥ìœ¼ë¡œ ì²œì²œíˆ ì´ë™)
                    const dx = player.x - this.x;
                    const dy = player.y - this.y;
                    const dist = Math.hypot(dx, dy);
                    if (dist > 1) {
                        this.x += dx / dist * 0.5; // 0.5 ì†ë„ë¡œ ì´ë™
                        this.y += dy / dist * 0.5;
                    }
                }
            }


            // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
            
            // ì‹œì‘ ë²„íŠ¼
            startButton.addEventListener('click', handleStartButton);
            // ì •ë³´ ë²„íŠ¼
            infoButton.addEventListener('click', showInfo);
            
            // ì´ë™
            canvas.addEventListener('mousemove', e => {
                const rect = canvas.getBoundingClientRect();
                targetPos.x = e.clientX - rect.left;
                targetPos.y = e.clientY - rect.top;
            });
            canvas.addEventListener('touchmove', e => {
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                targetPos.x = e.touches[0].clientX - rect.left;
                targetPos.y = e.touches[0].clientY - rect.top;
            }, { passive: false });
            
            // ëŒ€ì‹œ/ë¹™ì˜
            canvas.addEventListener('mousedown', e => {
                if (gameState === 'playing') player.dash();
            });
            canvas.addEventListener('touchstart', e => {
                if (e.target === canvas && gameState === 'playing') {
                    player.dash();
                }
            }, { passive: false });


            // --- í•µì‹¬ í•¨ìˆ˜ ---

            function handleStartButton() {
                if (gameOverlay.dataset.mode === 'info') {
                    setupStartScreen();
                } else {
                    startGame();
                }
            }

            function setupStartScreen() {
                gameOverlay.dataset.mode = 'start';
                instructions.style.display = 'none';
                overlayMessage.style.display = 'block';
                finalScoreDisplay.style.display = 'none';
                startButton.textContent = 'ì‹œì‘í•˜ê¸°';
            }
            
            function showInfo() {
                gameOverlay.dataset.mode = 'info';
                instructions.style.display = 'block'; // ì •ë³´ í‘œì‹œ
                overlayMessage.style.display = 'none'; // ê¸°ë³¸ ë©”ì‹œì§€ ìˆ¨ê¹€
                finalScoreDisplay.style.display = 'none';
                startButton.textContent = 'ëŒì•„ê°€ê¸°';
                gameOverlay.classList.remove('hidden');
            }

            function startGame() {
                score = 0;
                level = 1;
                frameCount = 0;
                scoreDisplay.textContent = `Score: 0`;
                levelDisplay.textContent = `Lv. 1`;
                
                player = new Player();
                enemies = [];
                projectiles = [];
                echoes = [];

                gameState = 'playing';
                gameOverlay.classList.add('hidden');
                
                gameLoop();
            }

            function endGame() {
                gameState = 'over';
                cancelAnimationFrame(gameLoopId);
                
                finalScoreDisplay.textContent = `ìµœì¢… ì ìˆ˜: ${score}`;
                finalScoreDisplay.style.display = 'block';
                startButton.textContent = 'ë‹¤ì‹œí•˜ê¸°';
                gameOverlay.classList.remove('hidden');
            }
            
            function spawnEnemies() {
                if (frameCount % 60 === 0) { // 1ì´ˆë§ˆë‹¤
                    const x = Math.random() < 0.5 ? 0 : VIEWPORT_WIDTH;
                    const y = Math.random() * VIEWPORT_HEIGHT;
                    const type = MOB_TYPES[Math.floor(Math.random() * MOB_TYPES.length)];
                    enemies.push(new Enemy(x, y, type));
                }
            }
            
            function checkCollisions() {
                // (TODO: ëª¨ë“  ì¶©ëŒ ë¡œì§ êµ¬í˜„)
                // 1. ìœ ë ¹ + ì  -> ê²Œì„ ì˜¤ë²„
                if (player.state === 'WISP' && player.unpossessTimer <= 0) {
                    enemies.forEach(enemy => {
                        if (Math.hypot(player.x - enemy.x, player.y - enemy.y) < player.radius + enemy.radius) {
                            endGame();
                        }
                    });
                }
                
                // 2. íˆ¬ì‚¬ì²´ + ì  -> ì  ì£½ìŒ, ì—ì½” ìƒì„±
                // 3. í”Œë ˆì´ì–´ + ì—ì½” -> ì ìˆ˜/ê²½í—˜ì¹˜
            }

            // --- ë©”ì¸ ê²Œì„ ë£¨í”„ ---
            function gameLoop() {
                if (gameState !== 'playing') return;

                // 1. í´ë¦¬ì–´
                ctx.fillStyle = "#1a1a2e";
                ctx.fillRect(0, 0, VIEWPORT_WIDTH, VIEWPORT_HEIGHT);
                
                // 2. ìƒì„±
                spawnEnemies();
                
                // 3. ì—…ë°ì´íŠ¸
                player.update();
                enemies.forEach(e => e.update());
                // (TODO: projectiles.forEach(p => p.update()));
                // (TODO: echoes.forEach(e => e.update()));
                
                // 4. ì¶©ëŒ
                checkCollisions();
                
                // 5. ê·¸ë¦¬ê¸°
                player.draw();
                enemies.forEach(e => e.draw());
                // (TODO: projectiles.forEach(p => p.draw()));
                // (TODO: echoes.forEach(e => e.draw()));
                
                gameLoopId = requestAnimationFrame(gameLoop);
            }
            
            // ì´ˆê¸° í™”ë©´ ì„¤ì •
            setupStartScreen();
        });
    </script>

</body>
</html>
